<!doctype html>
<html>
  <head>
    <title>chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
    </style>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  </head>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

  
    <body class="container">
        <div id="login-box">
            <h3>Ingresa tu nombre de usuario</h2>
            <input type="text" id="username"/>
            <button id="login">Ingresar</button>
        </div>
        <div id="contactos-box">
            <h3>Contactos</h3>
            <div id="contactos-list"></div>
        </div>

        <div id="conversaciones-box" class="accordion">

        </div>
               
        <ul id="messages"></ul>
        <form>
            <input id="m" autocomplete="off" />
            <button id="btn-send">Send</button>
        </form>

    </body>

    <script>
        var socket;
        var remitente;
        var usuario;
        $("body").delegate("#login", "click", function(){
            let user = {
                "username": $("#username").val()
            };
            remitente = $("#username").val();
            usuario = $("#username").val();
            $.ajax({
                url: '/user',
                dataType: 'text',
                type: 'post',
                contentType: 'application/x-www-form-urlencoded',
                data: user,
                success: function( data, textStatus, jQxhr ){
                    loginExitoso();
                },
                error: function( jqXhr, textStatus, errorThrown ){
                    console.log("Error al logear");
                }
            });
        });

        $("body").delegate(".btn-conversar", "click", function(){
            $(this).prop( "disabled", true );
            let destinatario = $(this).attr("data-user");
            crearEnlaceRemitenteDestinatario(remitente, destinatario);
        });

        $("body").delegate(".btn-enviar", "click", function(){
            let idElement = $(this).attr("data-idConversacion");
            let mensaje = $(`.mensaje-${idElement}`).val();

            socket.emit('chat message', {
                "room": idElement,
                "mensaje": mensaje
            });
        });


        function loginExitoso(){
            $("#login-box").hide();
            $("#contactos-box").show();

            $.ajax({
                url: '/user',
                dataType: 'json',
                type: 'get',
                contentType: 'application/x-www-form-urlencoded',
                success: function( data, textStatus, jQxhr ){
                    cargarContactos(data);
                },
                error: function( jqXhr, textStatus, errorThrown ){
                    console.log("Error al cargar contactos");
                }
            });
        }

        function cargarContactos(data){
            $("#contactos-list").append(generarBotonesContactos(data));
        }

        function generarBotonesContactos(data){
            let template = "";
            data.forEach(element => {
                template += `<button data-user="${element}" 
                                     class="btn btn-primary btn-conversar">${element}<button>`;
            });
            return template;
        }

        function generarCajaConversacion(conversacion){
            var elementId = `${conversacion.remitente}-${conversacion.destinatario}`;
            return `
                <div data-chat="${elementId}"
                     class="card"
                     "
                >
                    <div class="chat-box-header card-header" id="heading${elementId}">
                        <button class="btn btn-link" 
                            type="button" 
                            data-toggle="collapse" 
                            data-target="#${elementId}" 
                            aria-expanded="true" 
                            aria-controls="${elementId}">    
                                ${conversacion.destinatario}
                        </button>
                    </div>
                    <div id="${elementId}" 
                        class="collapse card-body show" 
                        aria-labelledby="heading${elementId}" 
                        data-parent="#conversaciones-box">
                            <div class=" card-body">
                                <ul class="chat-box-messages-${elementId}">
                                </ul>    
                            </div>
                            <div class="chat-box-input">
                                <input type="text" class="mensaje-${elementId}" />
                                <button class="btn-enviar btn btn-secondary"
                                        data-idConversacion="${elementId}">Enviar</button>   
                            </div>
                    </div>
                </div>
            `;
        }
        
        function agregarNuevaConversacion(conversacion){
            //Verificar que no exista una caja con este contacto
            $("#conversaciones-box").append(generarCajaConversacion(conversacion));
        }

        

        function crearEnlaceRemitenteDestinatario(remitente, destinatario){
            let conversacion = {
                "remitente": remitente,
                "destinatario": destinatario
            };
            socket.emit('join chat', conversacion);
        }

        function agregarNuevoMensaje(roomMessage){
            $(".chat-box-messages-" + roomMessage.room).append("<li>"+roomMessage.mensaje+"</li>");
        }

        $(function () {
            socket = io();

            $("#contactos-box").hide();

            // $('form').submit(function(e){
            //     e.preventDefault(); // prevents page reloading
            //     socket.emit('chat message', $('#m').val());
            //     $('#m').val('');
            //     return false;
            // });

            // socket.on('chat message', function(msg){
            //     $('#messages').append($('<li>').text(msg));
            // });

            socket.on('join chat', function(conversacion){
                if(usuario == conversacion.destinatario || usuario == conversacion.remitente){
                    socket.emit("join chat verified", conversacion);
                }
            });

            socket.on('join chat verified', function(conversacion){
                agregarNuevaConversacion(conversacion);
            });

            socket.on('chat message', function(roomMessage){
                agregarNuevoMensaje(roomMessage);
            });
        });
    </script>
</html>